                      'ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ê°€ê¹Œìš´ ì§€í•˜ì² ì—­ ${min(_visibleStations.length, 60)}ê°œ',
                      style: AppTextStyles.bodyMedium.copyWith(
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: AppSpacing.sm),
                Expanded(
                  child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: min(_visibleStations.length, 20), // í•˜ë‹¨ íŒ¨ë„ì—ëŠ” ìµœëŒ€ 20ê°œë§Œ í‘œì‹œ
                    itemBuilder: (context, index) {
                      final station = _visibleStations[index];
                      final distance = locationProvider.calculateDistanceToStation(
                        station.toSubwayStation(),
                      );

                      return Container(
                        margin: const EdgeInsets.only(right: AppSpacing.md),
                        child: InkWell(
                          onTap: () => _moveToStation(station),
                          child: Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: AppSpacing.md,
                              vertical: AppSpacing.sm,
                            ),
                            decoration: BoxDecoration(
                              color: AppColors.primary.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(AppRadius.medium),
                              border: Border.all(
                                color: AppColors.primary.withOpacity(0.3),
                              ),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  station.stationName,
                                  style: AppTextStyles.bodySmall.copyWith(
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                if (distance != null)
                                  Text(
                                    locationProvider.formatDistance(distance),
                                    style: AppTextStyles.caption.copyWith(
                                      color: AppColors.primary,
                                    ),
                                  ),
                              ],
                            ),
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  /// ì§€ë„ë¥¼ í•´ë‹¹ ì—­ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
  Future<void> _moveToStation(SeoulSubwayStation station) async {
    if (_mapController != null) {
      final cameraUpdate = NCameraUpdate.scrollAndZoomTo(
        target: NLatLng(station.latitude, station.longitude),
        zoom: 17,
      );
      await _mapController!.updateCamera(cameraUpdate);
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('${station.stationName}ìœ¼ë¡œ ì´ë™'),
            duration: const Duration(seconds: 1),
          ),
        );
      }
    }
  }
}import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:flutter_naver_map/flutter_naver_map.dart';
import 'package:flutter_spinkit/flutter_spinkit.dart';
import '../constants/app_constants.dart';
import '../constants/api_constants.dart';
import '../providers/location_provider.dart';
import '../providers/seoul_subway_provider.dart';
import '../models/subway_station.dart';
import '../models/seoul_subway_station.dart';
import '../models/station_group.dart';
import '../services/seoul_subway_api_service.dart';
import 'multi_line_station_detail_screen.dart';

/// ë„¤ì´ë²„ ì§€ë„ ë„¤ì´í‹°ë¸Œ í™”ë©´ (ì„œìš¸ ì§€í•˜ì²  API ì‚¬ìš©)
class NaverNativeMapScreen extends StatefulWidget {
  const NaverNativeMapScreen({super.key});

  @override
  State<NaverNativeMapScreen> createState() => _NaverNativeMapScreenState();
}

class _NaverNativeMapScreenState extends State<NaverNativeMapScreen> {
  NaverMapController? _mapController;
  bool _isLoading = false;
  String? _errorMessage;
  final List<NMarker> _markers = [];
  NMarker? _currentLocationMarker;
  List<SeoulSubwayStation> _displayedStations = [];

  @override
  void initState() {
    super.initState();
    print('ì„œìš¸ ì§€í•˜ì²  ì§€ë„ í™”ë©´ ì‹œì‘');
    
    // ì•± ì‹œì‘ ì‹œ ì§€í•˜ì² ì—­ ë§ˆì»¤ ìë™ ë¡œë“œ
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _loadSeoulSubwayStations();
    });
  }

  /// ì„œìš¸ ì§€í•˜ì²  API ë°ì´í„°ë¡œ ì—­ ë¡œë“œ
  Future<void> _loadSeoulSubwayStations() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      final seoulSubwayProvider = context.read<SeoulSubwayProvider>();
      
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
      if (!seoulSubwayProvider.hasStations) {
        await seoulSubwayProvider.initialize();
      }

      // ëª¨ë“  ì„œìš¸ ì§€í•˜ì² ì—­ ê°€ì ¸ì˜¤ê¸°
      final allStations = seoulSubwayProvider.allStations;
      
      // ì¢Œí‘œê°€ ìˆëŠ” ì—­ë“¤ë§Œ í•„í„°ë§
      final stationsWithCoordinates = allStations
          .where((station) => station.latitude != 0.0 && station.longitude != 0.0)
          .toList();

      setState(() {
        _displayedStations = stationsWithCoordinates;
        _isLoading = false;
      });

      print('ì„œìš¸ ì§€í•˜ì² ì—­ ë¡œë“œ ì™„ë£Œ: ì „ì²´ ${allStations.length}ê°œ, ì¢Œí‘œ ìˆìŒ ${stationsWithCoordinates.length}ê°œ');

      // ì§€ë„ê°€ ì¤€ë¹„ë˜ì—ˆìœ¼ë©´ ë§ˆì»¤ ì¶”ê°€
      if (_mapController != null) {
        await _addSeoulSubwayStationMarkers();
      }

    } catch (e) {
      print('ì„œìš¸ ì§€í•˜ì² ì—­ ë¡œë“œ ì˜¤ë¥˜: $e');
      setState(() {
        _isLoading = false;
        _errorMessage = 'ì§€í•˜ì² ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $e';
      });
    }
  }

  Future<void> _onMapReady(NaverMapController controller) async {
    _mapController = controller;
    print('ë„¤ì´ë²„ ì§€ë„ ì¤€ë¹„ ì™„ë£Œ');
    
    final locationProvider = context.read<LocationProvider>();
    
    // í˜„ì¬ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ì§€ë„ì— í‘œì‹œ
    if (locationProvider.currentPosition != null) {
      await _addCurrentLocationMarker(
        locationProvider.currentPosition!.latitude,
        locationProvider.currentPosition!.longitude,
      );
    }
    
    // ì„œìš¸ ì§€í•˜ì² ì—­ ë§ˆì»¤ ì¶”ê°€
    if (_displayedStations.isNotEmpty) {
      await _addSeoulSubwayStationMarkers();
    } else {
      // ì—†ìœ¼ë©´ ìƒˆë¡œ ë¡œë“œ
      await _loadSeoulSubwayStations();
    }
  }

  /// ì„œìš¸ ì§€í•˜ì²  API ë°ì´í„°ë¡œ ë§ˆì»¤ ì¶”ê°€
  Future<void> _addSeoulSubwayStationMarkers() async {
    if (_mapController == null || _displayedStations.isEmpty) return;

    try {
      print('ì„œìš¸ ì§€í•˜ì² ì—­ ë§ˆì»¤ ì¶”ê°€ ì‹œì‘: ${_displayedStations.length}ê°œ');

      // ê¸°ì¡´ ì§€í•˜ì² ì—­ ë§ˆì»¤ë“¤ ì œê±°
      await _clearSubwayMarkers();

      // ë§ˆì»¤ í‘œì‹œ ê°œìˆ˜ ì œí•œ (ì„±ëŠ¥ì„ ìœ„í•´ 200ê°œë¡œ ì œí•œ)
      final maxMarkers = 200;
      final stationsToShow = _displayedStations.length > maxMarkers 
          ? _displayedStations.take(maxMarkers).toList()
          : _displayedStations;

      for (int i = 0; i < stationsToShow.length; i++) {
        final station = stationsToShow[i];
        
        // ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
        final markerIcon = await _buildStationMarkerIcon(station.lineName, context);
        
        final marker = NMarker(
          id: 'seoul_station_$i',
          position: NLatLng(station.latitude, station.longitude),
          icon: markerIcon,
          anchor: const NPoint(0.5, 0.5),
        );

        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ - ì—­ ì •ë³´ í‘œì‹œ
        marker.setOnTapListener((overlay) {
          print('${station.stationName} ë§ˆì»¤ í´ë¦­ë¨');
          _showSeoulStationInfo(station);
        });

        await _mapController!.addOverlay(marker);
        _markers.add(marker);
      }

      print('ì„œìš¸ ì§€í•˜ì² ì—­ ë§ˆì»¤ ${_markers.length}ê°œ ì¶”ê°€ ì™„ë£Œ');
      setState(() {});
      
    } catch (e) {
      print('ì„œìš¸ ì§€í•˜ì² ì—­ ë§ˆì»¤ ì¶”ê°€ ì˜¤ë¥˜: $e');
    }
  }

  /// ì„œìš¸ ì§€í•˜ì² ì—­ ì •ë³´ í‘œì‹œ
  void _showSeoulStationInfo(SeoulSubwayStation station) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      builder: (context) => Container(
        padding: const EdgeInsets.all(16),
        constraints: BoxConstraints(
          maxHeight: MediaQuery.of(context).size.height * 0.6,
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // ì—­ëª…ê³¼ í˜¸ì„ 
            Row(
              children: [
                CircleAvatar(
                  backgroundColor: _getLineColor(station.lineName),
                  radius: 16,
                  child: Text(
                    station.lineName,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        station.stationName,
                        style: const TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        '${station.lineName}í˜¸ì„ ',
                        style: TextStyle(
                          fontSize: 14,
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            
            const SizedBox(height: 16),
            
            // ìƒì„¸ ì •ë³´
            Card(
              child: Padding(
                padding: const EdgeInsets.all(12),
                child: Column(
                  children: [
                    _buildInfoRow(Icons.location_on, 'ìœ„ì¹˜', 
                        '${station.latitude.toStringAsFixed(6)}, ${station.longitude.toStringAsFixed(6)}'),
                    if (station.stationCode != null)
                      _buildInfoRow(Icons.confirmation_number, 'ì—­ì½”ë“œ', station.stationCode!),
                    if (station.subwayTypeName != null)
                      _buildInfoRow(Icons.train, 'ì§€í•˜ì² êµ¬ë¶„', station.subwayTypeName!),
                  ],
                ),
              ),
            ),
            
            const SizedBox(height: 16),
            
            // ì•¡ì…˜ ë²„íŠ¼ë“¤
            Row(
              children: [
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: () {
                      Navigator.pop(context);
                      _navigateToStationDetail(station);
                    },
                    icon: const Icon(Icons.info_outline),
                    label: const Text('ìƒì„¸ ì •ë³´'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue,
                      foregroundColor: Colors.white,
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: () {
                      Navigator.pop(context);
                      _moveToStation(station);
                    },
                    icon: const Icon(Icons.center_focus_strong),
                    label: const Text('ì§€ë„ ì¤‘ì‹¬'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.green,
                      foregroundColor: Colors.white,
                    ),
                  ),
                ),
              ],
            ),
            
            const SizedBox(height: 8),
            
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('ë‹«ê¸°'),
            ),
          ],
        ),
      ),
    );
  }

  /// ì •ë³´ í–‰ ë¹Œë”
  Widget _buildInfoRow(IconData icon, String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          Icon(icon, size: 16, color: Colors.grey[600]),
          const SizedBox(width: 8),
          Text(
            '$label: ',
            style: const TextStyle(fontWeight: FontWeight.w500),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(color: Colors.grey[700]),
            ),
          ),
        ],
      ),
    );
  }

  /// ì—­ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
  void _navigateToStationDetail(SeoulSubwayStation seoulStation) {
    // SeoulSubwayStationì„ SubwayStationìœ¼ë¡œ ë³€í™˜
    final station = seoulStation.toSubwayStation();
    
    // StationGroup ìƒì„±
    final stationGroup = StationGroup(
      stationName: station.stationName,
      stations: [station],
    );
    
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => MultiLineStationDetailScreen(
          stationGroup: stationGroup,
          initialStation: station,
        ),
      ),
    );
  }

  /// ì§€ë„ë¥¼ í•´ë‹¹ ì—­ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
  Future<void> _moveToStation(SeoulSubwayStation station) async {
    if (_mapController != null) {
      final cameraUpdate = NCameraUpdate.scrollAndZoomTo(
        target: NLatLng(station.latitude, station.longitude),
        zoom: 16,
      );
      await _mapController!.updateCamera(cameraUpdate);
    }
  }

  Future<void> _addCurrentLocationMarker(double lat, double lng) async {
    if (_mapController == null) return;

    try {
      // ê¸°ì¡´ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
      if (_currentLocationMarker != null) {
        await _mapController!.deleteOverlay(_currentLocationMarker!.info);
      }

      // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
      final markerIcon = await NOverlayImage.fromWidget(
        widget: Container(
          width: 24,
          height: 24,
          decoration: BoxDecoration(
            color: const Color(0xFF4285F4),
            shape: BoxShape.circle,
            border: Border.all(
              color: Colors.white,
              width: 3,
            ),
            boxShadow: const [
              BoxShadow(
                color: Colors.black26,
                blurRadius: 6,
                offset: Offset(0, 3),
              ),
              BoxShadow(
                color: Color(0xFF4285F4),
                blurRadius: 12,
                spreadRadius: -3,
                offset: Offset(0, 0),
              ),
            ],
          ),
          child: Container(
            margin: const EdgeInsets.all(6),
            decoration: const BoxDecoration(
              color: Colors.white,
              shape: BoxShape.circle,
            ),
          ),
        ),
        size: const Size(24, 24),
        context: context,
      );

      // ìƒˆë¡œìš´ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
      _currentLocationMarker = NMarker(
        id: 'current_location',
        position: NLatLng(lat, lng),
        icon: markerIcon,
        anchor: const NPoint(0.5, 0.5),
      );

      // ë§ˆì»¤ë¥¼ ì§€ë„ì— ì¶”ê°€
      await _mapController!.addOverlay(_currentLocationMarker!);

      // ì •ë³´ì°½ ì„¤ì •
      final infoWindow = NInfoWindow.onMarker(
        id: _currentLocationMarker!.info.id,
        text: 'í˜„ì¬ ìœ„ì¹˜',
      );
      _currentLocationMarker!.openInfoWindow(infoWindow);

      print('í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ: $lat, $lng');
    } catch (e) {
      print('í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ ì˜¤ë¥˜: $e');
    }
  }

  /// ì§€í•˜ì² ì—­ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
  Future<NOverlayImage> _buildStationMarkerIcon(String lineNumber, BuildContext context) async {
    final color = _getLineColor(lineNumber);
    return await NOverlayImage.fromWidget(
      widget: Container(
        width: 28,
        height: 28,
        decoration: BoxDecoration(
          color: color,
          shape: BoxShape.circle,
          border: Border.all(
            color: Colors.white,
            width: 3,
          ),
          boxShadow: const [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 6,
              offset: Offset(0, 3),
            ),
          ],
        ),
        child: Center(
          child: Text(
            lineNumber,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 12,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
      ),
      size: const Size(28, 28),
      context: context,
    );
  }

  Color _getLineColor(String lineNumber) {
    final colors = {
      '1': const Color(0xFF263c96),
      '2': const Color(0xFF00a650),
      '3': const Color(0xFFef7c1c),
      '4': const Color(0xFF00a4e3),
      '5': const Color(0xFF996cac),
      '6': const Color(0xFFcd7c2f),
      '7': const Color(0xFF747f00),
      '8': const Color(0xFFe6186c),
      '9': const Color(0xFFbdb092),
    };
    return colors[lineNumber] ?? const Color(0xFF757575);
  }

  Future<void> _clearSubwayMarkers() async {
    if (_mapController == null) return;

    try {
      for (final marker in _markers) {
        await _mapController!.deleteOverlay(marker.info);
      }
      _markers.clear();
      print('ì§€í•˜ì² ì—­ ë§ˆì»¤ ì œê±° ì™„ë£Œ');
    } catch (e) {
      print('ì§€í•˜ì² ì—­ ë§ˆì»¤ ì œê±° ì˜¤ë¥˜: $e');
    }
  }

  Future<void> _getCurrentLocation() async {
    try {
      setState(() {
        _isLoading = true;
        _errorMessage = null;
      });

      final locationProvider = context.read<LocationProvider>();

      // ìœ„ì¹˜ ê¶Œí•œ í™•ì¸
      if (!locationProvider.hasLocationPermission) {
        final granted = await locationProvider.requestLocationPermission();
        if (!granted) {
          setState(() {
            _isLoading = false;
            _errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
          });
          return;
        }
      }

      // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
      await locationProvider.getCurrentLocation();
      
      if (locationProvider.currentPosition != null) {
        final lat = locationProvider.currentPosition!.latitude;
        final lng = locationProvider.currentPosition!.longitude;

        // ì§€ë„ ì¹´ë©”ë¼ ì´ë™
        if (_mapController != null) {
          final cameraUpdate = NCameraUpdate.scrollAndZoomTo(
            target: NLatLng(lat, lng),
            zoom: 15,
          );
          await _mapController!.updateCamera(cameraUpdate);
        }

        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
        await _addCurrentLocationMarker(lat, lng);
      } else {
        setState(() {
          _errorMessage = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        });
      }

      setState(() {
        _isLoading = false;
      });
    } catch (e) {
      print('ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: $e');
      setState(() {
        _isLoading = false;
        _errorMessage = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ì„œìš¸ ì§€í•˜ì²  ì§€ë„'),
        actions: [
          // ì„œìš¸ ì§€í•˜ì² ì—­ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () async {
              await _loadSeoulSubwayStations();
            },
            tooltip: 'ì§€í•˜ì² ì—­ ìƒˆë¡œê³ ì¹¨',
          ),
          PopupMenuButton<String>(
            onSelected: (value) async {
              switch (value) {
                case 'refresh_all':
                  setState(() {
                    _isLoading = true;
                  });
                  await _clearSubwayMarkers();
                  await _loadSeoulSubwayStations();
                  await _getCurrentLocation();
                  setState(() {
                    _isLoading = false;
                  });
                  break;
                case 'clear':
                  await _clearSubwayMarkers();
                  if (_currentLocationMarker != null && _mapController != null) {
                    await _mapController!.deleteOverlay(_currentLocationMarker!.info);
                    _currentLocationMarker = null;
                  }
                  setState(() {
                    _displayedStations = [];
                  });
                  break;
                case 'seoul_only':
                  // ì„œìš¸ ì§€ì—­ë§Œ í•„í„°ë§
                  final seoulStations = _displayedStations
                      .where((station) => 
                          station.latitude >= 37.4 && 
                          station.latitude <= 37.7 &&
                          station.longitude >= 126.7 && 
                          station.longitude <= 127.3)
                      .toList();
                  setState(() {
                    _displayedStations = seoulStations;
                  });
                  await _addSeoulSubwayStationMarkers();
                  break;
              }
            },
            itemBuilder: (context) => [
              const PopupMenuItem(
                value: 'refresh_all',
                child: Row(
                  children: [
                    Icon(Icons.clear),
                    SizedBox(width: 8),
                    Text('ë§ˆì»¤ ì§€ìš°ê¸°'),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
      body: Stack(
        children: [
          // ë„¤ì´ë²„ ì§€ë„
          NaverMap(
            options: const NaverMapViewOptions(
              initialCameraPosition: NCameraPosition(
                target: NLatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­
                zoom: 12,
                bearing: 0,
                tilt: 0,
              ),
              indoorEnable: true,
              locationButtonEnable: false,
              consumeSymbolTapEvents: false,
              mapType: NMapType.basic,
              activeLayerGroups: [NLayerGroup.building, NLayerGroup.transit],
            ),
            onMapReady: _onMapReady,
            onCameraChange: _onCameraChange,
            onCameraIdle: _onCameraIdle,
            onMapTapped: (point, coord) {
              print('ğŸ—ºï¸ ì§€ë„ í´ë¦­: ${coord.latitude}, ${coord.longitude}');
            },
          ),

          // ì—ëŸ¬ ë©”ì‹œì§€
          if (_errorMessage != null)
            Positioned(
              top: 16,
              left: 16,
              right: 16,
              child: Card(
                color: Colors.red.withOpacity(0.9),
                child: Padding(
                  padding: const EdgeInsets.all(AppSpacing.md),
                  child: Row(
                    children: [
                      const Icon(Icons.error_outline, color: Colors.white),
                      const SizedBox(width: AppSpacing.sm),
                      Expanded(
                        child: Text(
                          _errorMessage!,
                          style: const TextStyle(color: Colors.white),
                        ),
                      ),
                      IconButton(
                        icon: const Icon(Icons.close, color: Colors.white),
                        onPressed: () {
                          setState(() {
                            _errorMessage = null;
                          });
                        },
                      ),
                    ],
                  ),
                ),
              ),
            ),

          // ë¡œë”© ì¸ë””ì¼€ì´í„°
          if (_isLoading)
            Container(
              color: Colors.black54,
              child: const Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SpinKitWave(
                      color: AppColors.primary,
                      size: 50.0,
                    ),
                    SizedBox(height: AppSpacing.md),
                    Text(
                      'ì§€í•˜ì²  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),

      // í•˜ë‹¨ ì •ë³´ íŒ¨ë„
      bottomSheet: Consumer<LocationProvider>(
        builder: (context, locationProvider, child) {
          if (_visibleStations.isEmpty) {
            return const SizedBox.shrink();
          }

          return Container(
            height: 100,
            padding: const EdgeInsets.all(AppSpacing.md),
            decoration: const BoxDecoration(
              color: AppColors.surface,
              borderRadius: BorderRadius.vertical(
                top: Radius.circular(AppRadius.large),
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black12,
                  blurRadius: 10,
                  offset: Offset(0, -2),
                ),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    const Icon(
                      Icons.train,
                      color: AppColors.primary,
                      size: 20,
                    ),
                    const SizedBox(width: AppSpacing.sm),
                    Text(
                      'ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ê°€ê¹Œìš´ ì§€í•˜ì² ì—­ ${min(_visibleStations.length, 60)}ê°œ',
                      style: AppTextStyles.bodyMedium.copyWith(
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: AppSpacing.sm),
                Expanded(
                  child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: min(_visibleStations.length, 20), // í•˜ë‹¨ íŒ¨ë„ì—ëŠ” ìµœëŒ€ 20ê°œë§Œ í‘œì‹œ
                    itemBuilder: (context, index) {
                      final station = _visibleStations[index];
                      final distance = locationProvider.calculateDistanceToStation(
                        station.toSubwayStation(),
                      );

                      return Container(
                        margin: const EdgeInsets.only(right: AppSpacing.md),
                        child: InkWell(
                          onTap: () => _moveToStation(station),
                          child: Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: AppSpacing.md,
                              vertical: AppSpacing.sm,
                            ),
                            decoration: BoxDecoration(
                              color: AppColors.primary.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(AppRadius.medium),
                              border: Border.all(
                                color: AppColors.primary.withOpacity(0.3),
                              ),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  station.stationName,
                                  style: AppTextStyles.bodySmall.copyWith(
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                if (distance != null)
                                  Text(
                                    locationProvider.formatDistance(distance),
                                    style: AppTextStyles.caption.copyWith(
                                      color: AppColors.primary,
                                    ),
                                  ),
                              ],
                            ),
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}(Icons.refresh),
                    SizedBox(width: 8),
                    Text('ì „ì²´ ìƒˆë¡œê³ ì¹¨'),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'seoul_only',
                child: Row(
                  children: [
                    Icon(Icons.location_city),
                    SizedBox(width: 8),
                    Text('ì„œìš¸ ì§€ì—­ë§Œ'),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'clear',
                child: Row(
                  children: [
                    Icon(Icons.clear),
                    SizedBox(width: 8),
                    Text('ë§ˆì»¤ ì§€ìš°ê¸°'),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
      body: Stack(
        children: [
          // ë„¤ì´ë²„ ì§€ë„
          NaverMap(
            options: const NaverMapViewOptions(
              initialCameraPosition: NCameraPosition(
                target: NLatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­
                zoom: 12,
                bearing: 0,
                tilt: 0,
              ),
              indoorEnable: true,
              locationButtonEnable: false,
              consumeSymbolTapEvents: false,
              mapType: NMapType.basic,
              activeLayerGroups: [NLayerGroup.building, NLayerGroup.transit],
            ),
            onMapReady: _onMapReady,
            onMapTapped: (point, coord) {
              print('ì§€ë„ í´ë¦­: ${coord.latitude}, ${coord.longitude}');
            },
          ),

          // ë‚´ ìœ„ì¹˜ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨)
          Positioned(
            right: 16,
            bottom: 100,
            child: FloatingActionButton.small(
              onPressed: _isLoading ? null : _getCurrentLocation,
              backgroundColor: _isLoading 
                  ? Colors.green.withOpacity(0.6) 
                  : Colors.green,
              foregroundColor: Colors.white,
              elevation: 4,
              heroTag: 'location_button',
              child: _isLoading
                  ? const SizedBox(
                      width: 16,
                      height: 16,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    )
                  : const Icon(
                      Icons.my_location,
                      size: 20,
                    ),
            ),
          ),

          // ì—ëŸ¬ ë©”ì‹œì§€
          if (_errorMessage != null)
            Positioned(
              top: 100,
              left: 16,
              right: 16,
              child: Card(
                color: Colors.red.withOpacity(0.9),
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Row(
                    children: [
                      const Icon(
                        Icons.error_outline,
                        color: Colors.white,
                      ),
                      const SizedBox(width: AppSpacing.sm),
                      Expanded(
                        child: Text(
                          _errorMessage!,
                          style: const TextStyle(color: Colors.white),
                        ),
                      ),
                      IconButton(
                        icon: const Icon(Icons.close, color: Colors.white),
                        onPressed: () {
                          setState(() {
                            _errorMessage = null;
                          });
                        },
                      ),
                    ],
                  ),
                ),
              ),
            ),

          // ë¡œë”© ì¸ë””ì¼€ì´í„°
          if (_isLoading)
            Container(
              color: Colors.black54,
              child: const Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SpinKitWave(
                      color: AppColors.primary,
                      size: 50.0,
                    ),
                    SizedBox(height: AppSpacing.md),
                    Text(
                      'ì§€í•˜ì²  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),

      // í•˜ë‹¨ ì •ë³´ íŒ¨ë„
      bottomSheet: Consumer<LocationProvider>(
        builder: (context, locationProvider, child) {
          if (_visibleStations.isEmpty) {
            return const SizedBox.shrink();
          }

          return Container(
            height: 100,
            padding: const EdgeInsets.all(AppSpacing.md),
            decoration: const BoxDecoration(
              color: AppColors.surface,
              borderRadius: BorderRadius.vertical(
                top: Radius.circular(AppRadius.large),
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black12,
                  blurRadius: 10,
                  offset: Offset(0, -2),
                ),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    const Icon(
                      Icons.train,
                      color: AppColors.primary,
                      size: 20,
                    ),
                    const SizedBox(width: AppSpacing.sm),
                    Text(
                      'ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ê°€ê¹Œìš´ ì§€í•˜ì² ì—­ ${min(_visibleStations.length, 60)}ê°œ',
                      style: AppTextStyles.bodyMedium.copyWith(
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: AppSpacing.sm),
                Expanded(
                  child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: min(_visibleStations.length, 20), // í•˜ë‹¨ íŒ¨ë„ì—ëŠ” ìµœëŒ€ 20ê°œë§Œ í‘œì‹œ
                    itemBuilder: (context, index) {
                      final station = _visibleStations[index];
                      final distance = locationProvider.calculateDistanceToStation(
                        station.toSubwayStation(),
                      );

                      return Container(
                        margin: const EdgeInsets.only(right: AppSpacing.md),
                        child: InkWell(
                          onTap: () => _moveToStation(station),
                          child: Container(
                            padding: const EdgeInsets.symmetric(
                              horizontal: AppSpacing.md,
                              vertical: AppSpacing.sm,
                            ),
                            decoration: BoxDecoration(
                              color: AppColors.primary.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(AppRadius.medium),
                              border: Border.all(
                                color: AppColors.primary.withOpacity(0.3),
                              ),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  station.stationName,
                                  style: AppTextStyles.bodySmall.copyWith(
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                if (distance != null)
                                  Text(
                                    locationProvider.formatDistance(distance),
                                    style: AppTextStyles.caption.copyWith(
                                      color: AppColors.primary,
                                    ),
                                  ),
                              ],
                            ),
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}(width: 8),
                      Expanded(
                        child: Text(
                          _errorMessage!,
                          style: const TextStyle(
                            color: Colors.white,
                          ),
                        ),
                      ),
                      IconButton(
                        icon: const Icon(Icons.close, color: Colors.white),
                        onPressed: () {
                          setState(() {
                            _errorMessage = null;
                          });
                        },
                      ),
                    ],
                  ),
                ),
              ),
            ),

          // ë¡œë”© ì¸ë””ì¼€ì´í„°
          if (_isLoading)
            Container(
              color: Colors.black54,
              child: const Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    SpinKitWave(
                      color: Colors.green,
                      size: 50.0,
                    ),
                    SizedBox(height: 16),
                    Text(
                      'ì„œìš¸ ì§€í•˜ì²  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                      ),
                    ),
                  ],
                ),
              ),
            ),

          // ì—­ ê°œìˆ˜ í‘œì‹œ
          Positioned(
            top: 100,
            left: 16,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(20),
                boxShadow: const [
                  BoxShadow(
                    color: Colors.black26,
                    blurRadius: 4,
                    offset: Offset(0, 2),
                  ),
                ],
              ),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Icon(
                    Icons.train,
                    color: Colors.green,
                    size: 16,
                  ),
                  const SizedBox(width: 4),
                  Text(
                    'ì„œìš¸ ì§€í•˜ì² : ${_displayedStations.length}ê°œ',
                    style: const TextStyle(
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _mapController?.dispose();
    super.dispose();
  }
}
